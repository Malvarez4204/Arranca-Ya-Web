<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arranca Ya! - HistÃ³rico</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --green-primary: #66BB6A;
            --green-dark: #388E3C;
            --green-light: #E8F5E9;
            --gray-light: #f4f7f6;
            --white: #fff;
            --text-color: #212121;
        }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--gray-light);
            color: var(--text-color);
            line-height: 1.6;
        }
        .navbar {
            background-color: var(--green-dark);
            overflow: hidden;
            text-align: center;
        }
        .navbar a {
            display: inline-block;
            color: white;
            padding: 14px 20px;
            text-decoration: none;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        .navbar a:hover {
            background-color: #2e7d32;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        h2 {
            font-size: 2rem;
            color: var(--green-dark);
            margin-bottom: 20px;
        }
        .section-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 40px;
        }
        .section-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .section-buttons a,
        .section-buttons button {
            background-color: var(--green-dark);
            color: var(--white);
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        .section-buttons a:hover,
        .section-buttons button:hover {
            background-color: #2e7d32;
            transform: translateY(-2px);
        }
        .footer {
            background-color: var(--green-dark);
            color: var(--white);
            text-align: center;
            padding: 20px;
            margin-top: 20px;
        }
        /* --- CHAT WIDGET --- */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--green-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .chat-box {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            overflow: hidden;
            flex-direction: column;
        }
        .chat-header {
            background: var(--green-dark);
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
        }
        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.9rem;
        }
        .chat-input {
            display: flex;
            border-top: 1px solid #ddd;
        }
        .chat-input input {
            flex: 1;
            border: none;
            padding: 10px;
        }
        .chat-input button {
            background: var(--green-primary);
            border: none;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
        }
        /* --- Tabla de ventas --- */
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .sales-table th, .sales-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .sales-table th {
            background-color: var(--green-light);
            color: var(--text-color);
        }
        /* --- Formulario de ventas --- */
        .sales-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
            text-align: left;
        }
        .sales-form input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .sales-form button {
            background-color: var(--green-dark);
            color: var(--white);
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
    </style>
    <script src='https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body onload="cargarDatos()">
    <nav class="navbar">
        <a href="index.html">Inicio</a>
        <a href="registro.html">Registro</a>
        <a href="cursos.html">Cursos</a>
        <a href="historico.html">HistÃ³rico</a>
        <a href="asesoria.html">AsesorÃ­a</a>
        <a href="contacto.html">Contacto</a>
        <a href="asistente.html">Asistente</a>
    </nav>
    <div class="container">
        <h2>HistÃ³rico de Movimientos</h2>
        <div class="section-container">
            <h2>Compras</h2>
            <div class="section-buttons">
                <button onclick="iniciarEscaneo()">Escanear Ticket</button>
                <button onclick="generarReporteDeCompras()">Reporte de Compras</button>
            </div>
        </div>
        <div class="section-container">
            <h2>Ventas</h2>
            <div class="section-buttons">
                <button onclick="mostrarFormularioVentas()">Registro de Ventas</button>
                <button onclick="iniciarRegistroPorVoz()">Registro por Voz</button>
            </div>
        </div>
        
        <div id="ventasContainer" style="display:none;">
            <h3>Registrar Nueva Venta</h3>
            <form class="sales-form">
                <input type="text" id="producto" placeholder="Producto" required>
                <input type="number" id="cantidad" placeholder="Cantidad" step="1" required>
                <input type="number" id="monto" placeholder="Monto" step="0.01" required>
                <input type="date" id="fecha" required>
                <button type="button" onclick="agregarProducto()">Agregar a la Venta</button>
                <button type="button" onclick="emitirTicket()">Emitir Ticket</button>
            </form>
            
            <h3>Resumen de la Venta</h3>
            <table class="sales-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Monto</th>
                    </tr>
                </thead>
                <tbody id="salesTableBody">
                </tbody>
            </table>
            <h3 style="margin-top:20px;">
                Total de Venta Actual: <span id="totalVentaActual">$0.00</span>
            </h3>
        </div>

        <div id="graficoVentas" style="margin-top: 40px;">
            <h3>Ventas HistÃ³ricas por Producto</h3>
            <canvas id="salesChart"></canvas>
            <p id="noDataMessage" style="text-align: center; color: #777;"></p>
        </div>

        <div class="section-container">
            <h2>Reportes de Ventas</h2>
            <div class="section-buttons">
                <button onclick="generarReporteDeVentas('day')">Reporte Diario</button>
                <button onclick="generarReporteDeVentas('week')">Reporte Semanal</button>
                <button onclick="generarReporteDeVentas('month')">Reporte Mensual</button>
            </div>
        </div>
    </div>
    <footer class="footer">
        <p>Â© 2025 Arranca Ya!. Todos los derechos reservados.</p>
    </footer>
    <button class="chat-button" onclick="toggleChat()">ðŸ¤–</button>
    <div class="chat-box" id="chatBox">
        <div class="chat-header">Soy Sparkia, tu asistente virtual ðŸ¤–</div>
        <div class="chat-messages" id="chatMessages">
            <p><strong>Sparkia:</strong> Â¡Hola! Â¿En quÃ© puedo ayudarte hoy?</p>
        </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="Escribe un mensaje...">
            <button onclick="sendMessage()">âž¤</button>
        </div>
    </div>
    
    <script>
        const { jsPDF } = window.jspdf;
        let ventas = [];
        let productosParaTicket = [];
        let chartInstance = null;
        let totalVentaActual = 0;
        
        function cargarDatos() {
            const datosGuardados = localStorage.getItem('historialVentas');
            if (datosGuardados) {
                ventas = JSON.parse(datosGuardados);
            }
            generarGraficoVentas();
        }

        function guardarDatos() {
            localStorage.setItem('historialVentas', JSON.stringify(ventas));
        }

        function mostrarFormularioVentas() {
            const ventasContainer = document.getElementById('ventasContainer');
            ventasContainer.style.display = 'block';
            document.getElementById('fecha').valueAsDate = new Date();
        }

        function iniciarRegistroPorVoz() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert("Lo siento, tu navegador no soporta el reconocimiento de voz.");
                return;
            }
            
            mostrarFormularioVentas();
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.start();

            recognition.onstart = function() {
                alert("Escuchando... Por favor, di algo como: 'VendÃ­ 5 tacos por 150 pesos'.");
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log("Lo que dijiste: " + transcript);

                const regex = /(?:vendÃ­|vendo|vendiste|venta de)\s*(\d+)\s*(.*?)\s*(?:por|en)\s*(\d+)/i;
                const match = transcript.match(regex);
                
                if (match && match.length === 4) {
                    const cantidad = match[1];
                    const producto = match[2].trim();
                    const monto = match[3];

                    document.getElementById('cantidad').value = cantidad;
                    document.getElementById('producto').value = producto;
                    document.getElementById('monto').value = monto;
                    alert("Datos cargados. Revisa el formulario y haz clic en 'Agregar a la Venta'.");
                } else {
                    alert("No pude entender la frase. IntÃ©ntalo de nuevo con un formato como: 'VendÃ­ 5 tacos por 150'.");
                }
            };

            recognition.onerror = function(event) {
                console.error("Error de reconocimiento de voz:", event.error);
                alert("OcurriÃ³ un error con el reconocimiento de voz. AsegÃºrate de tener permiso para el micrÃ³fono.");
            };
        }

        function agregarProducto() {
            const producto = document.getElementById('producto').value;
            const cantidad = parseInt(document.getElementById('cantidad').value, 10);
            const monto = parseFloat(document.getElementById('monto').value);

            if (producto && !isNaN(cantidad) && !isNaN(monto)) {
                const nuevoProducto = { producto, cantidad, monto, fecha: document.getElementById('fecha').value };
                productosParaTicket.push(nuevoProducto);
                
                totalVentaActual += (cantidad * monto);
                document.getElementById('totalVentaActual').textContent = `$${totalVentaActual.toFixed(2)}`;

                actualizarTablaProductos();
                
                document.getElementById('producto').value = '';
                document.getElementById('cantidad').value = '';
                document.getElementById('monto').value = '';
            } else {
                alert("Por favor, completa todos los campos con valores vÃ¡lidos.");
            }
        }
        
        function emitirTicket() {
            if (productosParaTicket.length === 0) {
                alert("No hay productos para emitir en el ticket.");
                return;
            }
            
            const doc = new jsPDF();
            let y = 15;
            
            doc.setFontSize(18);
            doc.text("Recibo de Venta", 10, y);
            y += 10;
            doc.setFontSize(12);
            doc.text("--------------------------------------", 10, y);
            y += 10;
            
            productosParaTicket.forEach(item => {
                doc.text(`Producto: ${item.producto}`, 10, y);
                y += 7;
                doc.text(`Cantidad: ${item.cantidad}`, 10, y);
                y += 7;
                doc.text(`Monto: $${item.monto.toFixed(2)}`, 10, y);
                y += 10;
            });
            
            doc.text("--------------------------------------", 10, y);
            y += 10;
            doc.setFontSize(14);
            doc.text(`Total: $${totalVentaActual.toFixed(2)}`, 10, y);

            doc.save(`ticket_${new Date().getTime()}.pdf`);
            alert("Ticket PDF generado y descargado.");
            
            ventas = ventas.concat(productosParaTicket);
            productosParaTicket = [];
            totalVentaActual = 0;
            document.getElementById('totalVentaActual').textContent = `$0.00`;
            actualizarTablaProductos();
            guardarDatos();
            generarGraficoVentas();
        }
        
        function actualizarTablaProductos() {
            const tbody = document.getElementById('salesTableBody');
            tbody.innerHTML = '';
            
            productosParaTicket.forEach(item => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${item.producto}</td>
                    <td>${item.cantidad}</td>
                    <td>$${item.monto.toFixed(2)}</td>
                `;
                tbody.appendChild(fila);
            });
        }
        
        function generarGraficoVentas() {
            const noDataMessage = document.getElementById('noDataMessage');
            const canvas = document.getElementById('salesChart');
            const ctx = canvas.getContext('2d');

            if (ventas.length === 0) {
                noDataMessage.textContent = 'No hay datos de ventas aÃºn. Â¡Registra una venta para ver el grÃ¡fico!';
                if (chartInstance) {
                    chartInstance.destroy();
                    chartInstance = null;
                }
                canvas.style.display = 'none';
                return;
            }

            noDataMessage.textContent = '';
            canvas.style.display = 'block';

            const ventasPorProducto = {};
            ventas.forEach(venta => {
                if (ventasPorProducto[venta.producto]) {
                    ventasPorProducto[venta.producto] += venta.cantidad * venta.monto;
                } else {
                    ventasPorProducto[venta.producto] = venta.cantidad * venta.monto;
                }
            });

            const labels = Object.keys(ventasPorProducto);
            const data = Object.values(ventasPorProducto);

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas por Producto',
                        data: data,
                        backgroundColor: [
                            '#66BB6A', '#388E3C', '#E8F5E9', '#A5D6A7', '#4CAF50'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Total de Ventas por Producto'
                        }
                    }
                }
            });
        }

        // Nueva funciÃ³n para generar reportes de ventas filtrados
        function generarReporteDeVentas(periodo) {
            if (ventas.length === 0) {
                alert('No hay ventas registradas para generar un reporte.');
                return;
            }

            const hoy = new Date();
            const ventasFiltradas = ventas.filter(venta => {
                const fechaVenta = new Date(venta.fecha);
                const diff = hoy.getTime() - fechaVenta.getTime();
                const diasDeDiferencia = diff / (1000 * 60 * 60 * 24);

                if (periodo === 'day' && diasDeDiferencia < 1) {
                    return true;
                }
                if (periodo === 'week' && diasDeDiferencia < 7) {
                    return true;
                }
                if (periodo === 'month' && diasDeDiferencia < 30) {
                    return true;
                }
                return false;
            });

            if (ventasFiltradas.length === 0) {
                alert(`No se encontraron ventas para el periodo '${periodo}'.`);
                return;
            }

            const doc = new jsPDF();
            let y = 15;
            let totalGeneral = 0;
            const titulo = `Reporte de Ventas por ${periodo.charAt(0).toUpperCase() + periodo.slice(1)}`;

            doc.setFontSize(18);
            doc.text(titulo, 10, y);
            y += 10;
            doc.setFontSize(12);
            doc.text("--------------------------------------", 10, y);
            y += 10;

            ventasFiltradas.forEach(item => {
                doc.text(`Producto: ${item.producto}`, 10, y);
                y += 7;
                doc.text(`Cantidad: ${item.cantidad}`, 10, y);
                y += 7;
                doc.text(`Monto: $${item.monto.toFixed(2)}`, 10, y);
                y += 7;
                doc.text(`Fecha: ${item.fecha}`, 10, y);
                y += 10;
                totalGeneral += item.cantidad * item.monto;
            });
            
            doc.text("--------------------------------------", 10, y);
            y += 10;
            doc.setFontSize(14);
            doc.text(`Total del Periodo: $${totalGeneral.toFixed(2)}`, 10, y);

            doc.save(`Reporte_Ventas_${periodo}.pdf`);
            alert("Reporte PDF generado y descargado.");
        }

        async function iniciarEscaneo() {
            console.log("Activando escÃ¡ner...");
            alert("Â¡Por favor, toma una foto del ticket para escanearlo!");

            const input = document.createElement('input');
            input.type = 'file';
            input.setAttribute('capture', 'environment');
            input.accept = 'image/*';
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) {
                     console.log("SelecciÃ³n de archivo cancelada.");
                     return;
                }

                console.log("Procesando imagen con Tesseract.js...");

                Tesseract.recognize(
                  file,
                  'spa',
                  { logger: m => console.log(m) }
                ).then(({ data: { text } }) => {
                  console.log("Texto extraÃ­do:", text);

                  const montoMatch = text.match(/(?:total|importe|subtotal)\s*[\$\â‚¬]?\s*([\d\.\,]+)/i);
                  const montoTotal = montoMatch ? `$${parseFloat(montoMatch[1].replace(',', '.')).toFixed(2)}` : "Monto no encontrado";

                  const doc = new jsPDF();
                  doc.setFontSize(16);
                  doc.text("Reporte de Gasto - Arranca Ya!", 10, 10);
                  doc.setFontSize(12);
                  doc.text(`Monto total: ${montoTotal}`, 10, 20);
                  doc.text("--- Texto completo del ticket ---", 10, 40);
                  const splitText = doc.splitTextToSize(text, 180);
                  doc.text(splitText, 10, 50);
                  doc.save("Reporte_de_Gasto.pdf");

                  alert("Â¡Reporte PDF generado y descargado con Ã©xito!");
                }).catch(err => {
                    console.error("Error al procesar la imagen:", err);
                    alert("OcurriÃ³ un error al procesar el ticket. Intenta con otra foto.");
                });
            };
            input.click();
        }

        function generarReporteDeCompras() {
            console.log("Generando reporte de compras...");
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("Reporte de Compras", 10, 10);
            doc.setFontSize(12);
            doc.text("Fecha: 15/09/2025", 10, 20);
            doc.text("--- ArtÃ­culos ---", 10, 30);
            const articulos = [
                { nombre: "Masa", costo: "25.00" },
                { nombre: "Agua", costo: "12.50" },
                { nombre: "Chiles", costo: "30.00" }
            ];
            let y = 40;
            articulos.forEach(item => {
                doc.text(`${item.nombre}: $${item.costo}`, 15, y);
                y += 10;
            });
            doc.save("Reporte_de_Compras.pdf");
            alert("Â¡Reporte de Compras generado y descargado con Ã©xito!");
        }

        function toggleChat() {
            const chat = document.getElementById("chatBox");
            chat.style.display = (chat.style.display === "flex") ? "none" : "flex";
        }
        function sendMessage() {
            const input = document.getElementById("userInput");
            const msg = input.value.trim();
            if (msg === "") return;
            const messages = document.getElementById("chatMessages");
            const userMsg = document.createElement("p");
            userMsg.innerHTML = "<strong>TÃº:</strong> " + msg;
            messages.appendChild(userMsg);
            const botMsg = document.createElement("p");
            botMsg.innerHTML = "<strong>Sparkia:</strong> Estoy en desarrollo, pero siempre aquÃ­ para ayudarte ðŸš€";
            messages.appendChild(botMsg);
            messages.scrollTop = messages.scrollHeight;
            input.value = "";
        }
    </script>
</body>
</html>