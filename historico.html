<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Arranca Ya! - Hist칩rico</title>

<!-- Fuentes y librer칤as -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src='https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
:root{
  --green-primary:#66BB6A;
  --green-dark:#388E3C;
  --green-light:#E8F5E9;
  --gray-light:#f4f7f6;
  --white:#fff;
  --text-color:#212121;
  --orange-light:#FFCCBC;
  --orange-dark:#FF7043;
}
body{
  font-family:'Poppins',sans-serif;
  margin:0;
  padding:0;
  background:var(--gray-light);
  color:var(--text-color);
}

/* Navbar */
.navbar{
  background: var(--green-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 50px;
  padding: 15px;
  flex-wrap: wrap;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.navbar img{
  height: 100px;
}
.navbar a{
  color: #fff;
  padding: 10px 16px;
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  transition: 0.3s;
}
.navbar a:hover{
  color: var(--green-light);
  background-color: rgba(255,255,255,0.1);
  border-radius: 6px;
}

/* Contenedor principal */
.container{
  max-width:1000px;
  margin:40px auto;
  padding:30px;
  background:var(--white);
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,0.08);
}
h2,h3{
  color:var(--green-dark);
  text-align:center;
}

/* Secciones */
.section-container{
  margin-top:40px;
  padding:20px;
  border-radius:12px;
  background:#f9f9f9;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

/* Botones */
.section-buttons{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:16px;
}
button{
  background: linear-gradient(145deg, #66BB6A, #4CAF50);
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  color:#fff;
  padding:10px 14px;
  border-radius:50px;
  border:none;
  cursor:pointer;
  font-weight:600;
  transition: transform 0.2s, box-shadow 0.2s;
}
button:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 10px rgba(0,0,0,0.25);
}

/* Formulario de ventas */
.sales-form{
  display:flex;
  flex-direction:column;
  gap:12px;
  max-width:100%;
}
input{
  padding:10px;
  border:1px solid #ddd;
  border-radius:6px;
  font-size:0.95rem;
}

/* Tablas */
.sales-table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}
.sales-table th{
  background: #A5D6A7;
  color: #212121;
}
.sales-table td{
  background: #E8F5E9;
}
.sales-table tr:hover{
  background-color: #C8E6C9;
  transition:0.2s;
}

/* Footer */
.footer{
  background: linear-gradient(90deg,#388E3C,#66BB6A);
  color:#fff;
  text-align:center;
  padding:25px;
  font-size:0.95rem;
  margin-top:20px;
}

/* Mensajes y canvas */
#noDataMessage,#noDataComprasMessage{text-align:center;color:#777;}
canvas{max-height:400px;}
</style>
</head>
<body onload="cargarDatos();cargarDatosCompras()">

<!-- Navbar con logo -->
<nav class="navbar">
  <img src="logo/logosinf.png" alt="Logo Arranca Ya!">
  <a href="perfil.html">Mi perfil</a>
  <a href="retos.html">Retos</a>
  <a href="cursos.html">Cursos</a>
  <a href="asesoria.html">Asesor칤a</a>
  <a href="asistente.html">Asistente</a>
  <a href="contacto.html">Contacto</a>
</nav>

<div class="container">
  <h2>Hist칩rico de Movimientos</h2>

  <!-- Compras -->
  <div class="section-container">
    <h3>Compras</h3>
    <div class="section-buttons">
      <button onclick="iniciarEscaneo()">Escanear Ticket</button>
      <button onclick="agregarCompraManual()">Registrar Compra Manual</button>
      <button onclick="generarReporteDeCompras()">Generar PDF de Compras</button>
    </div>

    <div id="graficoComprasContainer">
      <canvas id="comprasChart"></canvas>
      <p id="noDataComprasMessage"></p>
    </div>
  </div>

  <!-- Ventas -->
  <div class="section-container" style="margin-top:30px;">
    <h3>Ventas</h3>
    <div class="section-buttons">
      <button onclick="mostrarFormularioVentas()">Registro Manual</button>
      <button id="vozBtn" onclick="iniciarRegistroPorVoz()">Registro por Voz 游꿗</button>
    </div>

    <div style="display:flex;justify-content:center;gap:10px;margin-bottom:12px;">
      <button onclick="generarReporteVentas('diaria')">Reporte Diario</button>
      <button onclick="generarReporteVentas('semanal')">Reporte Semanal</button>
      <button onclick="generarReporteVentas('mensual')">Reporte Mensual</button>
    </div>

    <div id="ventasContainer" style="display:none;">
      <form class="sales-form" onsubmit="return false;">
        <input type="text" id="producto" placeholder="Producto" required>
        <input type="number" id="cantidad" placeholder="Cantidad" step="1" required>
        <input type="number" id="monto" placeholder="Monto" step="0.01" required>
        <input type="date" id="fecha" required>
        <div style="display:flex;gap:10px;">
          <button type="button" onclick="agregarProducto()">Agregar a la Venta</button>
          <button type="button" onclick="emitirTicket()">Emitir Ticket</button>
        </div>
      </form>

      <h3>Resumen de la Venta</h3>
      <table class="sales-table">
        <thead><tr><th>Producto</th><th>Cantidad</th><th>Monto</th></tr></thead>
        <tbody id="salesTableBody"></tbody>
      </table>
      <h3>Total: <span id="totalVentaActual">$0.00</span></h3>
      <button type="button" onclick="generarCodigoPago()">Generar C칩digo de Pago</button>
      <div id="qrContainer" style="text-align:center;margin-top:20px;"></div>

      <div id="graficoVentasContainer" style="margin-top:30px;">
        <canvas id="salesChart"></canvas>
        <p id="noDataMessage"></p>
      </div>
    </div>
  </div>
</div>

<footer class="footer">
  <p>춸 2025 Arranca Ya!. Todos los derechos reservados.</p>
</footer>

<script>
const { jsPDF } = window.jspdf;

// ---------- VENTAS ----------
let ventas = [];
let productosParaTicket = [];
let chartInstance = null;
let totalVentaActual = 0;

function cargarDatos(){
  const datosGuardados = localStorage.getItem('historialVentas');
  if(datosGuardados) ventas = JSON.parse(datosGuardados);
  generarGraficoVentas();
}
function guardarDatos(){ localStorage.setItem('historialVentas', JSON.stringify(ventas)); }

function mostrarFormularioVentas(){
  document.getElementById('ventasContainer').style.display='block';
  document.getElementById('fecha').valueAsDate = new Date();
}

function agregarProducto(){
  const producto = document.getElementById('producto').value.trim();
  const cantidad = parseInt(document.getElementById('cantidad').value,10);
  const monto = parseFloat(document.getElementById('monto').value);
  if(!producto || isNaN(cantidad) || isNaN(monto)){ alert('Completa los campos correctamente'); return; }
  const nuevo = { producto, cantidad, monto, fecha: document.getElementById('fecha').value };
  productosParaTicket.push(nuevo);
  totalVentaActual += cantidad*monto;
  document.getElementById('totalVentaActual').textContent=`$${totalVentaActual.toFixed(2)}`;
  actualizarTablaProductos();
  document.getElementById('producto').value=''; document.getElementById('cantidad').value=''; document.getElementById('monto').value='';
}

function actualizarTablaProductos(){
  const tbody = document.getElementById('salesTableBody');
  tbody.innerHTML='';
  productosParaTicket.forEach(item=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${item.producto}</td><td>${item.cantidad}</td><td>$${item.monto.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

function emitirTicket(){
  if(productosParaTicket.length===0){ alert('No hay productos para emitir.'); return; }
  const doc = new jsPDF(); let y=15;
  doc.setFontSize(18); doc.text('Recibo de Venta',10,y); y+=10;
  productosParaTicket.forEach(it=>{
    doc.setFontSize(12);
    doc.text(`Producto: ${it.producto}`,10,y); y+=7;
    doc.text(`Cantidad: ${it.cantidad}`,10,y); y+=7;
    doc.text(`Monto: $${it.monto.toFixed(2)}`,10,y); y+=10;
  });
  doc.setFontSize(14); doc.text(`Total: $${totalVentaActual.toFixed(2)}`,10,y);
  doc.save(`ticket_${Date.now()}.pdf`);
  ventas = ventas.concat(productosParaTicket);
  productosParaTicket=[]; totalVentaActual=0;
  document.getElementById('totalVentaActual').textContent='$0.00';
  actualizarTablaProductos(); guardarDatos(); generarGraficoVentas();
}

// ---------- GRAFICO VENTAS ----------
function generarGraficoVentas(){
  const noDataMessage = document.getElementById('noDataMessage');
  const canvas = document.getElementById('salesChart'); const ctx = canvas.getContext('2d');
  if(ventas.length===0){ noDataMessage.textContent='No hay datos de ventas a칰n.'; if(chartInstance){ chartInstance.destroy(); chartInstance=null;} canvas.style.display='none'; return; }
  noDataMessage.textContent=''; canvas.style.display='block';
  const ventasPorProducto={};
  ventas.forEach(v=>{ ventasPorProducto[v.producto]=(ventasPorProducto[v.producto]||0)+(v.cantidad*v.monto); });
  const labels=Object.keys(ventasPorProducto); const data=Object.values(ventasPorProducto);
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'pie',data:{labels,datasets:[{label:'Ventas por Producto',data,backgroundColor:['#66BB6A','#388E3C','#A5D6A7','#81C784','#4CAF50'],hoverOffset:4}]},options:{responsive:true,plugins:{legend:{position:'top'},title:{display:true,text:'Total de Ventas por Producto'}}}});
}

// ---------- CODIGO DE PAGO CON QR ----------
function generarCodigoPago() {
  if(productosParaTicket.length === 0){
    alert("No hay productos para generar el pago.");
    return;
  }

  const datosPago = {
    productos: productosParaTicket.map(p => ({producto: p.producto, cantidad: p.cantidad, monto: p.monto})),
    total: totalVentaActual,
    fecha: new Date().toISOString()
  };
  const qrTexto = JSON.stringify(datosPago);

  const qr = new QRious({ value: qrTexto, size: 200 });

  const doc = new jsPDF();
  let y = 15;
  doc.setFontSize(18); doc.text('Ticket de Pago', 10, y); y += 10;

  productosParaTicket.forEach(p => {
    doc.setFontSize(12);
    doc.text(`Producto: ${p.producto}`, 10, y); y += 7;
    doc.text(`Cantidad: ${p.cantidad}`, 10, y); y += 7;
    doc.text(`Monto: $${p.monto.toFixed(2)}`, 10, y); y += 10;
  });

  doc.setFontSize(14);
  doc.text(`Total: $${totalVentaActual.toFixed(2)}`, 10, y); y += 15;

  const qrDataURL = qr.toDataURL();
  doc.addImage(qrDataURL, 'PNG', 10, y, 50, 50);

  doc.save(`codigo_pago_${Date.now()}.pdf`);
}

// ---------- COMPRAS ----------
let compras=[];
let comprasChartInstance=null;

function cargarDatosCompras(){
  const datosCompras = localStorage.getItem('historialCompras');
  if(datosCompras) compras = JSON.parse(datosCompras);
  generarGraficoCompras();
}
function guardarDatosCompras(){ localStorage.setItem('historialCompras',JSON.stringify(compras)); }

function agregarCompraManual(){
  const producto = prompt("Nombre del producto comprado:");
  if(!producto) return alert("Debe ingresar el producto.");
  const cantidad = parseInt(prompt("Cantidad comprada:"),10);
  if(isNaN(cantidad)) return alert("Cantidad inv치lida.");
  const monto = parseFloat(prompt("Monto total de la compra:"));
  if(isNaN(monto)) return alert("Monto inv치lido.");
  const fecha = new Date().toISOString().split('T')[0];
  compras.push({producto,cantidad,monto,fecha});
  guardarDatosCompras(); generarGraficoCompras();
  alert(`Compra agregada: ${cantidad} ${producto} por $${monto.toFixed(2)}`);
}

function generarReporteDeCompras(){
  if(compras.length===0) return alert("No hay compras registradas.");
  const doc = new jsPDF(); let y=15;
  doc.setFontSize(16); doc.text("Reporte de Compras",10,y); y+=10;
  compras.forEach(c=>{
    doc.setFontSize(12);
    doc.text(`Producto: ${c.producto}`,10,y); y+=7;
    doc.text(`Cantidad: ${c.cantidad}`,10,y); y+=7;
    doc.text(`Monto: $${c.monto.toFixed(2)}`,10,y); y+=7;
    doc.text(`Fecha: ${c.fecha}`,10,y); y+=7;
    doc.text("-------------------------------",10,y); y+=7;
  });
  doc.save(`reporte_compras_${Date.now()}.pdf`);
}

function generarGraficoCompras(){
  const canvas=document.getElementById('comprasChart'); const ctx=canvas.getContext('2d');
  const noDataMessage=document.getElementById('noDataComprasMessage');
  if(compras.length===0){ noDataMessage.textContent='No hay datos de compras a칰n.'; if(comprasChartInstance){ comprasChartInstance.destroy(); comprasChartInstance=null;} canvas.style.display='none'; return; }
  noDataMessage.textContent=''; canvas.style.display='block';
  const comprasPorProducto={};
  compras.forEach(c=>{ comprasPorProducto[c.producto]=(comprasPorProducto[c.producto]||0)+(c.cantidad*c.monto); });
  const labels=Object.keys(comprasPorProducto); const data=Object.values(comprasPorProducto);
  if(comprasChartInstance) comprasChartInstance.destroy();
  comprasChartInstance=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Compras por Producto',data,backgroundColor:['#FF8A65','#FF7043','#FFCCBC','#FF5722','#FFAB91']}]},options:{responsive:true,plugins:{legend:{display:false},title:{display:true,text:'Total de Compras por Producto'}}}});
}

// ---------- ESCANEO OCR ----------
function iniciarEscaneo(){
  const archivo = document.createElement('input'); archivo.type='file'; archivo.accept='image/*';
  archivo.onchange=()=>{ const file=archivo.files[0]; if(!file) return;
    Tesseract.recognize(file,'spa',{logger:m=>console.log(m)}).then(({data:{text}})=>{
      const lineas = text.split('\n').filter(l=>l.trim()!=='');

      lineas.forEach(l=>{
        const partes = l.split(/[\s,]+/);
        if(partes.length>=3){
          const [producto,cantidad,monto] = partes;
          compras.push({producto,cantidad:parseInt(cantidad,10),monto:parseFloat(monto),fecha:new Date().toISOString().split('T')[0]});
        }
      });
      guardarDatosCompras(); generarGraficoCompras();
      alert('Ticket escaneado y registrado correctamente.');
    }).catch(err=>alert('Error al procesar la imagen: '+err));
  };
  archivo.click();
}
</script>
</body>
</html>
