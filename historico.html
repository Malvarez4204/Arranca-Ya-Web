<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arranca Ya! - HistÃ³rico</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src='https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --green-primary: #66BB6A;
      --green-dark: #388E3C;
      --green-light: #E8F5E9;
      --gray-light: #f4f7f6;
      --white: #fff;
      --text-color: #212121;
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--gray-light);
      color: var(--text-color);
      line-height: 1.6;
    }
    /* --- NAVBAR --- */
    .navbar {
      background-color: var(--green-dark);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    .navbar a {
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    .navbar a:hover { background-color: #2e7d32; }
    /* --- CONTENEDOR --- */
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background-color: var(--white);
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }
    h2 { font-size: 2rem; color: var(--green-dark); margin-bottom: 20px; text-align: center; }
    /* --- SECCIONES --- */
    .section-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; text-align: center; }
    .section-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    .section-buttons a, .section-buttons button {
      background-color: var(--green-dark);
      color: var(--white);
      padding: 12px 20px;
      text-decoration: none;
      border-radius: 50px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.3s ease;
      font-size: 0.9rem;
    }
    .section-buttons a:hover, .section-buttons button:hover { background-color: #2e7d32; transform: translateY(-2px); }
    /* --- TABLA --- */
    .sales-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
    .sales-table th, .sales-table td { border: 1px solid #ddd; padding: 8px; text-align: left; word-break: break-word; }
    .sales-table th { background-color: var(--green-light); color: var(--text-color); }
    /* --- FORMULARIO --- */
    .sales-form { display: flex; flex-direction: column; gap: 12px; max-width: 100%; margin: 0 auto; }
    .sales-form input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; font-size: 0.95rem; }
    .sales-form button { background-color: var(--green-dark); color: var(--white); padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
    /* --- CHAT WIDGET --- */
    .chat-button {
      position: fixed; bottom: 20px; right: 20px; background-color: var(--green-primary);
      color: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 24px; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 999;
    }
    .chat-box {
      display: none; position: fixed; bottom: 85px; right: 20px; width: 95%; max-width: 320px; max-height: 450px;
      background: white; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); overflow: hidden; flex-direction: column; z-index: 999;
    }
    .chat-header { background: var(--green-dark); color: white; padding: 10px; font-weight: bold; text-align: center; }
    .chat-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.85rem; }
    .chat-input { display: flex; border-top: 1px solid #ddd; }
    .chat-input input { flex: 1; border: none; padding: 10px; font-size: 0.9rem; }
    .chat-input button { background: var(--green-primary); border: none; color: white; padding: 10px 15px; cursor: pointer; }
    /* --- FOOTER --- */
    .footer { background-color: var(--green-dark); color: var(--white); text-align: center; padding: 20px; margin-top: 20px; font-size: 0.9rem; }
    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
      .navbar a { flex: 1 1 45%; text-align: center; padding: 10px; font-size: 0.9rem; }
      h2 { font-size: 1.5rem; }
      .section-buttons { flex-direction: column; gap: 10px; }
      .section-buttons button { width: 100%; }
    }
    @media (max-width: 480px) {
      .navbar a { flex: 1 1 100%; padding: 8px; font-size: 0.85rem; }
      .sales-table th, .sales-table td { font-size: 0.8rem; padding: 6px; }
      .chat-box { right: 10px; bottom: 75px; width: 90%; }
    }
  </style>
</head>
<body onload="cargarDatos()">
  <nav class="navbar">
    <a href="index.html">Inicio</a>
    <a href="registro.html">Registro</a>
    <a href="cursos.html">Cursos</a>
    <a href="retos.html">Retos</a>
    <a href="historico.html">HistÃ³rico</a>
    <a href="asesoria.html">AsesorÃ­a</a>
    <a href="contacto.html">Contacto</a>
    <a href="asistente.html">Asistente</a>
  </nav>

  <div class="container">
    <h2>HistÃ³rico de Movimientos</h2>

    <div class="section-container">
      <h2>Compras</h2>
      <div class="section-buttons">
        <button onclick="iniciarEscaneo()">Escanear Ticket</button>
        <button onclick="generarReporteDeCompras()">Reporte de Compras</button>
      </div>
    </div>

    <div class="section-container">
      <h2>Ventas</h2>
      <div class="section-buttons">
        <button onclick="mostrarFormularioVentas()">Registro de Ventas</button>
        <button onclick="iniciarRegistroPorVoz()">Registro por Voz</button>
      </div>
    </div>

    <div id="ventasContainer" style="display:none;">
      <h3>Registrar Nueva Venta</h3>
      <form class="sales-form">
        <input type="text" id="producto" placeholder="Producto" required>
        <input type="number" id="cantidad" placeholder="Cantidad" step="1" required>
        <input type="number" id="monto" placeholder="Monto" step="0.01" required>
        <input type="date" id="fecha" required>
        <button type="button" onclick="agregarProducto()">Agregar a la Venta</button>
        <button type="button" onclick="emitirTicket()">Emitir Ticket</button>
      </form>

      <h3>Resumen de la Venta</h3>
      <table class="sales-table">
        <thead>
          <tr><th>Producto</th><th>Cantidad</th><th>Monto</th></tr>
        </thead>
        <tbody id="salesTableBody"></tbody>
      </table>
      <h3 style="margin-top:20px;">Total de Venta Actual: <span id="totalVentaActual">$0.00</span></h3>
    </div>

    <div id="graficoVentas" style="margin-top: 40px;">
      <h3>Ventas HistÃ³ricas por Producto</h3>
      <canvas id="salesChart"></canvas>
      <p id="noDataMessage" style="text-align: center; color: #777;"></p>
    </div>

    <div class="section-container">
      <h2>Reportes de Ventas</h2>
      <div class="section-buttons">
        <button onclick="generarReporteDeVentas('day')">Reporte Diario</button>
        <button onclick="generarReporteDeVentas('week')">Reporte Semanal</button>
        <button onclick="generarReporteDeVentas('month')">Reporte Mensual</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Â© 2025 Arranca Ya!. Todos los derechos reservados.</p>
  </footer>

  <button class="chat-button" onclick="toggleChat()">ðŸ¤–</button>
  <div class="chat-box" id="chatBox">
    <div class="chat-header">Soy Sparkia, tu asistente virtual ðŸ¤–</div>
    <div class="chat-messages" id="chatMessages">
      <p><strong>Sparkia:</strong> Â¡Hola! Â¿En quÃ© puedo ayudarte hoy?</p>
    </div>
    <div class="chat-input">
      <input type="text" id="userInput" placeholder="Escribe un mensaje...">
      <button onclick="sendMessage()">âž¤</button>
    </div>
  </div>

  <script src="gamificacion.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    let ventas = [];
    let productosParaTicket = [];
    let chartInstance = null;
    let totalVentaActual = 0;

    function cargarDatos() {
      const datosGuardados = localStorage.getItem('historialVentas');
      if (datosGuardados) ventas = JSON.parse(datosGuardados);
      generarGraficoVentas();
    }

    function guardarDatos() { localStorage.setItem('historialVentas', JSON.stringify(ventas)); }
    function mostrarFormularioVentas() {
      const ventasContainer = document.getElementById('ventasContainer');
      ventasContainer.style.display = 'block';
      document.getElementById('fecha').valueAsDate = new Date();
    }

    // --- Registro por voz ---
    function iniciarRegistroPorVoz() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("Tu navegador no soporta reconocimiento de voz."); return;
      }
      mostrarFormularioVentas();
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-MX';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      recognition.onstart = () => alert("Escuchando... Ej: 'VendÃ­ 5 tacos por 150 pesos'.");
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const regex = /(?:vendÃ­|vendo|vendiste|venta de)\s*(\d+)\s*(.*?)\s*(?:por|en)\s*(\d+)/i;
        const match = transcript.match(regex);
        if (match && match.length === 4) {
          const cantidad = match[1], producto = match[2].trim(), monto = match[3];
          document.getElementById('cantidad').value = cantidad;
          document.getElementById('producto').value = producto;
          document.getElementById('monto').value = monto;
          alert("Datos cargados. Haz clic en 'Agregar a la Venta'.");
          agregarProducto();
        } else alert("Formato no reconocido. Intenta: 'VendÃ­ 5 tacos por 150'.");
      };
      recognition.onerror = (event) => alert("Error con reconocimiento de voz: " + event.error);
    }

    function agregarProducto() {
      const producto = document.getElementById('producto').value;
      const cantidad = parseInt(document.getElementById('cantidad').value,10);
      const monto = parseFloat(document.getElementById('monto').value);
      if (producto && !isNaN(cantidad) && !isNaN(monto)) {
        const nuevoProducto = { producto, cantidad, monto, fecha: document.getElementById('fecha').value };
        productosParaTicket.push(nuevoProducto);
        totalVentaActual += (cantidad * monto);
        document.getElementById('totalVentaActual').textContent = `$${totalVentaActual.toFixed(2)}`;
        actualizarTablaProductos();
        document.getElementById('producto').value='';
        document.getElementById('cantidad').value='';
        document.getElementById('monto').value='';
      } else alert("Completa todos los campos correctamente.");
    }

    function emitirTicket() {
      if(productosParaTicket.length===0){alert("No hay productos para emitir."); return;}
      const doc = new jsPDF(); let y=15;
      doc.setFontSize(18); doc.text("Recibo de Venta",10,y); y+=10;
      doc.setFontSize(12); doc.text("--------------------------------------",10,y); y+=10;
      productosParaTicket.forEach(item=>{
        doc.text(`Producto: ${item.producto}`,10,y); y+=7;
        doc.text(`Cantidad: ${item.cantidad}`,10,y); y+=7;
        doc.text(`Monto: $${item.monto.toFixed(2)}`,10,y); y+=10;
      });
      doc.text("--------------------------------------",10,y); y+=10;
      doc.setFontSize(14); doc.text(`Total: $${totalVentaActual.toFixed(2)}`,10,y);
      doc.save(`ticket_${new Date().getTime()}.pdf`);
      alert("Ticket PDF generado y descargado.");
      ventas = ventas.concat(productosParaTicket);
      productosParaTicket=[]; totalVentaActual=0;
      document.getElementById('totalVentaActual').textContent=`$0.00`;
      actualizarTablaProductos(); guardarDatos(); generarGraficoVentas();
      if(typeof Gy!=='undefined'){Gy.completeQuest('registra_primera_venta');}
    }

    function actualizarTablaProductos() {
      const tbody=document.getElementById('salesTableBody'); tbody.innerHTML='';
      productosParaTicket.forEach(item=>{
        const fila=document.createElement('tr');
        fila.innerHTML=`<td>${item.producto}</td><td>${item.cantidad}</td><td>$${item.monto.toFixed(2)}</td>`;
        tbody.appendChild(fila);
      });
    }

    function generarGraficoVentas() {
      const noDataMessage=document.getElementById('noDataMessage');
      const canvas=document.getElementById('salesChart'); const ctx=canvas.getContext('2d');
      if(ventas.length===0){noDataMessage.textContent='No hay datos de ventas aÃºn.'; if(chartInstance){chartInstance.destroy(); chartInstance=null;} canvas.style.display='none'; return;}
      noDataMessage.textContent=''; canvas.style.display='block';
      const ventasPorProducto={};
      ventas.forEach(venta=>{ventasPorProducto[venta.producto]?ventasPorProducto[venta.producto]+=venta.cantidad*venta.monto:ventasPorProducto[venta.producto]=venta.cantidad*venta.monto;});
      const labels=Object.keys(ventasPorProducto); const data=Object.values(ventasPorProducto);
      if(chartInstance){chartInstance.destroy();}
      chartInstance=new Chart(ctx,{type:'pie',data:{labels, datasets:[{label:'Ventas por Producto',data, backgroundColor:['#66BB6A','#388E3C','#E8F5E9','#A5D6A7','#4CAF50'],hoverOffset:4}]},options:{responsive:true,plugins:{legend:{position:'top'},title:{display:true,text:'Total de Ventas por Producto'}}}});
    }

    function generarReporteDeVentas(periodo){
      if(ventas.length===0){alert('No hay ventas registradas.'); return;}
      const hoy=new Date();
      const ventasFiltradas=ventas.filter(venta=>{
        const fechaVenta=new Date(venta.fecha);
        if(periodo==='day'){return fechaVenta.toDateString()===hoy.toDateString();}
        if(periodo==='week'){const primerDia=hoy.getDate()-hoy.getDay(); const ultimoDia=primerDia+6; const primerDiaSemana=new Date(hoy.setDate(primerDia)); const ultimoDiaSemana=new Date(hoy.setDate(ultimoDia)); return fechaVenta>=primerDiaSemana && fechaVenta<=ultimoDiaSemana;}
        if(periodo==='month'){return fechaVenta.getMonth()===hoy.getMonth() && fechaVenta.getFullYear()===hoy.getFullYear();}
        return false;
      });
      if(ventasFiltradas.length===0){alert('No hay ventas para el periodo seleccionado.'); return;}
      const doc=new jsPDF(); let y=15; doc.setFontSize(16); doc.text(`Reporte de Ventas (${periodo})`,10,y); y+=10;
      ventasFiltradas.forEach(v=>{
        doc.setFontSize(12); doc.text(`Producto: ${v.producto}`,10,y); y+=7;
        doc.text(`Cantidad: ${v.cantidad}`,10,y); y+=7;
        doc.text(`Monto: $${v.monto.toFixed(2)}`,10,y); y+=10;
      });
      doc.save(`reporte_${periodo}_${new Date().getTime()}.pdf`);
    }

    function toggleChat(){
      const chatBox=document.getElementById('chatBox');
      chatBox.style.display=(chatBox.style.display==='flex')?'none':'flex';
    }
    function sendMessage(){
      const input=document.getElementById('userInput'); const message=input.value.trim();
      if(!message) return; const chatMessages=document.getElementById('chatMessages');
      chatMessages.innerHTML+=`<p><strong>TÃº:</strong> ${message}</p>`;
      input.value=''; chatMessages.scrollTop=chatMessages.scrollHeight;
      setTimeout(()=>{chatMessages.innerHTML+=`<p><strong>Sparkia:</strong> Gracias por tu mensaje. Estoy procesando tu solicitud...</p>`; chatMessages.scrollTop=chatMessages.scrollHeight;},500);
    }

    // --- Escaneo de ticket usando Tesseract.js ---
    function iniciarEscaneo(){
      const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.click();
      input.onchange=(e)=>{
        const file=e.target.files[0]; if(!file)return;
        const reader=new FileReader();
        reader.onload=function(){
          Tesseract.recognize(reader.result,'spa',{logger:m=>console.log(m)}).then(({data:{text}})=>{
            alert("Texto detectado: "+text);
          });
        };
        reader.readAsDataURL(file);
      };
    }
  </script>
</body>
</html>
